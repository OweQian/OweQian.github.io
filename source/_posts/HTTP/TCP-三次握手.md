---
title: TCP-三次握手
img: https://upload.wikimedia.org/wikipedia/commons/thumb/5/5b/HTTP_logo.svg/1200px-HTTP_logo.svg.png
date: 2020-04-01 18:10:52
tags: [HTTP]
categories: 前端
---

#### 导语
> 建立 TCP 连接前，客户端和服务端需要通过三次握手来确认对方的接受和传送能力是否正常

<!--more-->           
***

客户端向服务器发送数据之前会发起 TCP 三次握手用以同步客户端和服务端的序列号和确认号，确保双方的接收和发送能力正常。

起始状态：客户端处于 closed 状态，服务端处于 listen 状态。

第一次握手：客户端给服务端发送一个 SYN 报文，并指明自己的初始化序列号（ISN） Seq = X，此时客户端处于 SYN_Send 状态。

第二次握手：服务端收到客户端的 SYN 报文后，会以自己的 SYN 报文作为应答，并且也指定了自己的初始化序列号（ISN） Seq = Y，同时会把客户端的 Seq X + 1 作为 ACK 的值，表示自己已经收到了客户端的 SYN，此时服务器处于 SYN_RCVD 的状态。

第三次握手：客户端回传一个 Seq Y + 1 作为 ACK 的值，Seq = Z 的数据包，代表握手结束，此时客户端处于 established 状态。

服务器收到 ACK 报文之后，也处于 established 状态，此时，双方建立起了连接。

（SYN：代表 TCP 连接 Seq：序列号 ACK：确认号）

![](https://segmentfault.com/img/remote/1460000017184707)

#### 为什么需要3次握手

为了防止已经失效的连接请求报文突然又传送到了服务器，因为产生错误。

#### ISN 是固定的吗

三次握手的一个重要功能是客户端和服务端交换ISN(Initial Sequence Number), 以便让对方知道接下来接收数据的时候如何按序列号组装数据。

如果ISN是固定的，攻击者很容易猜出后续的确认号，因此 ISN 是动态生成的。

#### 什么是半连接队列

服务器第一次收到客户端的 SYN 之后，此时会处于 SYN_RCVD 状态，此时双方还没有建立起连接，服务器会把这种状态的请求连接放在一个队列里，这种队列称为半连接队列。

服务器与客户端三次握手完成建立起的连接会放在全连接队列里。

如果队列满了，就可能会出现丢包现象。

```
这里在补充一点关于SYN-ACK 重传次数的问题： 服务器发送完SYN－ACK包，如果未收到客户确认包，服务器进行首次重传，等待一段时间仍未收到客户确认包，进行第二次重传，如果重传次数超 过系统规定的最大重传次数，系统将该连接信息从半连接队列中删除。注意，每次重传等待的时间不一定相同，一般会是指数增长，例如间隔时间为 1s, 2s, 4s, 8s, ....
```
